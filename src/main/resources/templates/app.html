<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::content})}">
<head>
    <title>Application</title>
</head>
<body>
<div th:fragment="content">
    <div id="hdr" class="mb-3"></div>
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card p-3">
                <h5>Checklist</h5>
                <div id="list"></div>
            </div>

            <div class="card p-3 mt-3">
                <h5>Documents</h5>
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="file" name="file" class="form-control mb-2">
                    <button class="btn btn-outline-secondary">Upload</button>
                </form>
                <ul id="docList" class="list-group mt-2"></ul>
            </div>

            <button class="btn btn-success mt-3" onclick="submitApp()">Submit Application</button>
            <div id="msg" class="small text-secondary mt-2"></div>
        </div>
        <div class="col-lg-6">
            <div class="card p-3">
                <h5>Timeline</h5>
                <ul id="timeline" class="list-group list-group-flush"></ul>
            </div>
        </div>
    </div>

    <script>
        const appId = location.pathname.split('/').pop();

        async function load(){
            const d = await fetch(`/api/v1/apps/${appId}`).then(r=>r.json());
            document.getElementById('hdr').innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="h5 mb-0">${d.programTitle}</div>
                        <div class="text-secondary small">${d.university}</div>
                    </div>
                    <span class="badge text-bg-secondary">${d.status}</span>
                </div>`;

            document.getElementById('list').innerHTML = d.checklist.map(it=>`
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <div>${it.name} ${it.required?'<span class="badge text-bg-light ms-2">required</span>':''}</div>
                    <select class="form-select form-select-sm" style="width:140px"
                            onchange="toggleItem(${d.id},${it.id},this.value)">
                        <option ${it.status==='PENDING'?'selected':''}>PENDING</option>
                        <option ${it.status==='DONE'?'selected':''}>DONE</option>
                    </select>
                </div>
            `).join('');

            await loadTimeline();
        }

        async function loadTimeline(){
            const t = await fetch(`/api/v1/apps/${appId}/timeline`).then(r=>r.json());
            document.getElementById('timeline').innerHTML = t.map(
                e=>`<li class="list-group-item d-flex justify-content-between">
                       <span>${e.event}</span>
                       <span class="text-secondary small">${new Date(e.created_at).toLocaleString()}</span>
                     </li>`).join('');
        }

        async function toggleItem(appId,itemId,status){
            const token = localStorage.getItem("token");
            await fetch(`/api/v1/apps/${appId}/items/${itemId}/status?status=${status}`,{method:'POST' , headers:{'Authorization':`Bearer ${token}`});
        }

        async function submitApp(){
            const token = localStorage.getItem("token");
            await fetch(`/api/v1/apps/${appId}/submit`,{method:'POST' , headers:{'Authorization':`Bearer ${token}`});
            document.getElementById('msg').innerText = 'Submitted';
            await load(); // refresh header & timeline
        }

        document.getElementById('uploadForm').onsubmit = async e => {
            e.preventDefault();
            const fd = new FormData(e.target);
            fd.append('appId', appId);
            const token = localStorage.getItem("token");
            await fetch('/api/v1/docs/upload', {
                method: 'POST' ,
                headers:{'Authorization':`Bearer ${token}`} ,
                body: fd
            });
            await loadDocs();
        };

        async function loadDocs() {
            const token = localStorage.getItem("token");
            const d = await fetch(`/api/v1/docs/${appId}`, { headers:{'Authorization':`Bearer ${token}`}}).then(r => r.json());
            document.getElementById('docList').innerHTML = d.map(f => `
                <li class="list-group-item">${f}</li>
            `).join('');
        }


        load();
        loadDocs();
    </script>
</div>
</body>
</html>
