<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::content})}">
<head>
    <title>Application</title>
</head>
<body>
<div th:fragment="content">
    <div id="hdr" class="mb-3"></div>
    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card p-3">
                <h5>Checklist</h5>
                <div id="list"></div>
            </div>

            <div class="card p-3 mt-3">
                <h5>Documents</h5>
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="file" name="file" class="form-control mb-2">
                    <button class="btn btn-outline-secondary">Upload</button>
                </form>
                <ul id="docList" class="list-group mt-2"></ul>
            </div>

            <button class="btn btn-success mt-3" onclick="submitApp()">Submit Application</button>
            <div id="msg" class="small text-secondary mt-2"></div>
        </div>
        <div class="col-lg-6">
            <div class="card p-3">
                <h5>Timeline</h5>
                <ul id="timeline" class="list-group list-group-flush"></ul>
            </div>
        </div>
    </div>

    <script>
        const appId = location.pathname.split('/').pop();

        async function load(){
            const d = await fetch(`/api/v1/apps/${appId}`).then(r=>r.json());
            document.getElementById('hdr').innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="h5 mb-0">${d.programTitle}</div>
                        <div class="text-secondary small">${d.university}</div>
                    </div>
                    <span class="badge text-bg-secondary">${d.status}</span>
                </div>`;

            document.getElementById('list').innerHTML = d.checklist.map(it=>`
                <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                    <div>${it.name} ${it.required?'<span class="badge text-bg-light ms-2">required</span>':''}</div>
                    <select class="form-select form-select-sm" style="width:140px"
                            onchange="toggleItem(${d.id},${it.id},this.value)">
                        <option ${it.status==='PENDING'?'selected':''}>PENDING</option>
                        <option ${it.status==='DONE'?'selected':''}>DONE</option>
                    </select>
                </div>
            `).join('');

            await loadTimeline();
        }

        async function loadTimeline(){
            const t = await fetch(`/api/v1/apps/${appId}/timeline`).then(r=>r.json());
            document.getElementById('timeline').innerHTML = t.map(
                e=>`<li class="list-group-item d-flex justify-content-between">
                       <span>${e.event}</span>
                       <span class="text-secondary small">${new Date(e.created_at).toLocaleString()}</span>
                     </li>`).join('');
        }

        async function toggleItem(appId,itemId,status){
            const token = localStorage.getItem("token");
            await fetch(`/api/v1/apps/${appId}/items/${itemId}/status?status=${status}`,{method:'POST' , headers:{'Authorization':`Bearer ${token}`}});
        }

        async function submitApp(){
            const token = localStorage.getItem("token");
            await fetch(`/api/v1/apps/${appId}/submit`,{method:'POST' , headers:{'Authorization':`Bearer ${token}`}});
            document.getElementById('msg').innerText = 'Submitted';
            await load(); // refresh header & timeline
        }

        document.getElementById('uploadForm').onsubmit = async e=>{
  e.preventDefault();
  const file = e.target.file.files[0];
  if(!file){ return; }

  // 1) Ask backend for presigned URL
  const pre = await fetch('/api/v1/docs/presign',{method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({appId, filename:file.name, mime:file.type, size:file.size})}).then(r=>r.json());

  // 2) Upload directly to S3
  await fetch(pre.url, {method:'PUT', body:file});

  // 3) Save metadata
  await fetch('/api/v1/docs/save',{method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({appId, key:pre.key, filename:file.name, mime:file.type, size:file.size, uploadedBy:1})});

  e.target.reset();
  await loadDocs();
};

async function loadDocs(){
  const d = await fetch(/api/v1/docs/${appId}).then(r=>r.json());
  docList.innerHTML = d.map(f=>
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <span>${f.original_name} <span class="text-secondary small">(${Math.round((f.size_bytes||0)/1024)} KB)</span></span>
      <span>
        <button class="btn btn-sm btn-outline-primary" onclick="previewDoc(${f.id})">Preview</button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteDoc(${f.id})">Delete</button>
      </span>
    </li>).join('');
}async function previewDoc(id){
  const {url} = await fetch(/api/v1/docs/presign-get/${id}).then(r=>r.json());
  window.open(url, '_blank');
}
async function deleteDoc(id){
  if(!confirm('Delete this file?')) return;
  await fetch('/api/v1/docs/'+id, {method:'DELETE'});
  await loadDocs();
}
    </script>
</div>
</body>
</html>
