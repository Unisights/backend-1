<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::content})}">
<head>
    <title>Programs</title>
</head>
<body>
<div th:fragment="content">
    <h3>Browse Programs</h3>
    <form id="filters" class="row g-2 mb-3">
        <div class="col"><select class="form-select" id="country"><option value="">Select Country</option></select></div>
        <div class="col"><input class="form-control" id="degree" placeholder="Degree (e.g., MS)"></div>
        <div class="col"><input class="form-control" id="feeMax" placeholder="Max Fee"></div>
        <div class="col"><input class="form-control" id="q" placeholder="Keyword"></div>
        <div class="col-auto"><button class="btn btn-primary">Search</button></div>
    </form>
    <div id="results"></div>

    <script>
        (async function loadCountries(){
            const token = localStorage.getItem("token");
            const r = await fetch('/api/v1/countries' , {headers: {'Authorization':`Bearer ${token}`}} );
            const countries = await r.json();
            const countrySelect = document.getElementById('country');
            countries.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                countrySelect.appendChild(opt);
            });
        })();

        async function search(e){
            e && e.preventDefault();
            const p=new URLSearchParams();
            if(country.value) p.append('country',country.value);
            if(degree.value) p.append('degree',degree.value);
            if(feeMax.value) p.append('feeMax',feeMax.value);
            if(q.value) p.append('q',q.value);
            const token = localStorage.getItem("token");
            const r=await fetch('/api/programs?'+p.toString() , {headers: {'Authorization':`Bearer ${token}`}});
            const data=await r.json();
            results.innerHTML = data.map(d=>`
            <div class="card p-3 mb-2">
              <div class="d-flex justify-content-between">
                <div><b>${d.title}</b><div class="text-secondary small">${d.university} • ${d.country} • ${d.degree}</div></div>
                <span class="badge text-bg-light">$${d.fee ?? '-'}</span>
              </div>
               <div class="d-flex gap-2 mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="checkEligibility(${d.id})">
                  Check eligibility
                </button>
                <button class="btn btn-sm btn-primary" onclick="applyNow(${d.id})">Apply</button>
              </div>
            </div>`).join('');
        }
        async function applyNow(programId){
            const token = localStorage.getItem("token");
            const r = await fetch('/api/v1/apps', {
                method:'POST', headers:{'Content-Type':'application/json' , 'Authorization':`Bearer ${token}`},
                body: JSON.stringify({ programId })
            });
            const app = await r.json();
            // go to the application page
            window.location.href = '/app/' + app.id;
        }

        async function checkEligibility(programId){
            try {
                const token = localStorage.getItem("token");
                const prof = await fetch('/api/v1/profile' , {headers: {'Authorization':`Bearer ${token}`}}).then(r=>r.ok?r.json():{});
                const req = {
                    gpa: (+prof.gpa) || 0,
                    ielts: (+prof.ielts) || 0,
                    toefl: (+prof.toefl) || 0,
                    budget: (+prof.budget) || 0,
                    programIds: [programId]
                };
                const token2 = localStorage.getItem("token");
                const res = await fetch('/api/v1/eligibility/check',{
                    method:'POST',
                    headers:{'Content-Type':'application/json' , 'Authorization':`Bearer ${token2}` },
                    body: JSON.stringify(req)
                }).then(r=>r.json());
                const r = res && res[0] ? res[0] : {score:0,eligible:false,reasons:['No data']};
                document.getElementById('eligBody').innerHTML = `
              <div>Score: <b>${r.score}</b> / 100</div>
              <div class="mt-2 ${r.eligible?'text-success':'text-danger'}">${r.eligible?'Eligible':'Not eligible'}</div>
              <ul class="mt-2">${(r.reasons||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
              <div class="mt-3"><a class="btn btn-primary disabled">Create draft (Day 4)</a></div>`;
            } catch(err){
                document.getElementById('eligBody').innerHTML = `<div class="text-danger">Error checking eligibility.</div>`;
            }
            new bootstrap.Modal(document.getElementById('eligModal')).show();
        }

        document.getElementById('filters').addEventListener('submit',search);
        search();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Eligibility Modal -->
    <div class="modal" tabindex="-1" id="eligModal">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eligibility</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eligBody">Checking...</div>
        </div></div>
    </div>
</div>
</body>
</html>