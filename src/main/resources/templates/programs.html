<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(~{::content})}">
<head>
    <title>Programs</title>
</head>
<body>
<div th:fragment="content">
    <h3>Browse Programs</h3>
    <form id="filters" class="row g-2 mb-3">
        <div class="col"><select class="form-select" id="country"><option value="">Select Country</option></select></div>
        <div class="col"><input class="form-control" id="degree" placeholder="Degree (e.g., MS)"></div>
        <div class="col"><input class="form-control" id="feeMax" placeholder="Max Fee"></div>
        <div class="col"><input class="form-control" id="q" placeholder="Keyword"></div>
        <div class="col-auto"><button class="btn btn-primary">Search</button></div>
    </form>
    <form id="pager" class="d-flex align-items-center gap-2 mb-2" onsubmit="return false;">
        <input id="q" class="form-control form-control-sm" placeholder="Search title..." style="width:220px">
        <select id="sort" class="form-select form-select-sm" style="width:160px">
            <option value="title">Title</option>
            <option value="university">University</option>
            <option value="degree">Degree</option>
            <option value="fee">Fee</option>
        </select>
        <select id="dir" class="form-select form-select-sm" style="width:100px">
            <option value="asc">Asc</option><option value="desc">Desc</option>
        </select>
        <select id="size" class="form-select form-select-sm" style="width:80px">
            <option>10</option><option>20</option><option>50</option>
        </select>

        <button id="prev" class="btn btn-sm btn-outline-secondary">Prev</button>
        <span id="pageno" class="small">1</span>
        <button id="next" class="btn btn-sm btn-outline-secondary">Next</button>
    </form>
    <script>
        const results = document.getElementById('results');
        const q = document.getElementById('q');
        const sort = document.getElementById('sort');
        const dir = document.getElementById('dir');
        const sizeEl = document.getElementById('size');
        const prev = document.getElementById('prev');
        const next = document.getElementById('next');
        const pageno = document.getElementById('pageno');

        let page = 1;

        function renderPrograms(list) {
          if (!list || list.length === 0) {
            results.innerHTML = '<div class="text-muted">No results</div>';
            return;
          }
          results.innerHTML = list.map(p => `
            <div class="card mb-2">
              <div class="card-body p-2">
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>${escapeHtml(p.title)}</strong>
                    <div class="small text-muted">${escapeHtml(p.university)} — ${escapeHtml(p.country)}</div>
                    <div class="small">${escapeHtml(p.degree)}</div>
                  </div>
                  <div class="text-end">
                    <div class="fw-bold">${p.fee == null ? '-' : '₹' + p.fee}</div>
                    <div class="small text-muted">Program ID: ${p.id}</div>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
        }

        function escapeHtml(str) {
          if (str == null) return '';
          return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
        }

        async function load() {
          pageno.textContent = page;
          const params = new URLSearchParams();
          if (q.value) params.append('q', q.value);
          params.append('page', page);
          params.append('size', sizeEl.value || 10);
          params.append('sort', sort.value);
          params.append('dir', dir.value);

          try {
            // show loading
            results.innerHTML = '<div class="text-center py-4">Loading…</div>';
            const r = await safeFetch('/api/programs?' + params.toString());
            const data = await r.json();
            renderPrograms(data);

            // disable prev/next appropriately
            prev.disabled = page <= 1;
            // If returned less than requested size -> assume no more pages
            next.disabled = !(Array.isArray(data) && data.length >= Number(sizeEl.value));
          } catch (err) {
            // safeFetch already showed toast; keep previous content or show error state
            results.innerHTML = '<div class="text-danger">Failed to load results</div>';
          }
        }

        // controls
        prev.addEventListener('click', e => { e.preventDefault(); if (page>1) { page--; load(); }});
        next.addEventListener('click', e => { e.preventDefault(); page++; load(); });
        sort.addEventListener('change', ()=>{ page = 1; load(); });
        dir.addEventListener('change', ()=>{ page = 1; load(); });
        sizeEl.addEventListener('change', ()=>{ page = 1; load(); });

        // debounce search input so you don't spam server
        function debounce(fn, wait=300){
          let t;
          return (...args) => { clearTimeout(t); t = setTimeout(()=> fn(...args), wait); };
        }
        q.addEventListener('input', debounce(()=>{ page = 1; load(); }, 400));
        q.addEventListener('keydown', (e)=> { if (e.key === 'Enter') { e.preventDefault(); page = 1; load(); }});

        // initial load
        load();
    </script>


    <div id="results"></div>
    <script>
        (async function loadCountries(){
            const token = localStorage.getItem("token");
            const r = await fetch('/api/v1/countries' , {headers: {'Authorization':`Bearer ${token}`}} );
            const countries = await r.json();
            const countrySelect = document.getElementById('country');
            countries.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                countrySelect.appendChild(opt);
            });
        })();

        async function search(e){
            e && e.preventDefault();
            const p=new URLSearchParams();
            if(country.value) p.append('country',country.value);
            if(degree.value) p.append('degree',degree.value);
            if(feeMax.value) p.append('feeMax',feeMax.value);
            if(q.value) p.append('q',q.value);
            const token = localStorage.getItem("token");
            const r=await fetch('/api/programs?'+p.toString() , {headers: {'Authorization':`Bearer ${token}`}});
            const data=await r.json();
            results.innerHTML = data.map(d=>`
            <div class="card p-3 mb-2">
              <div class="d-flex justify-content-between">
                <div><b>${d.title}</b><div class="text-secondary small">${d.university} • ${d.country} • ${d.degree}</div></div>
                <span class="badge text-bg-light">$${d.fee ?? '-'}</span>
              </div>
               <div class="d-flex gap-2 mt-2">
                <button class="btn btn-sm btn-outline-primary" onclick="checkEligibility(${d.id})">
                  Check eligibility
                </button>
                <button class="btn btn-sm btn-primary" onclick="applyNow(${d.id})">Apply</button>
              </div>
            </div>`).join('');
        }
        async function applyNow(programId){
            const token = localStorage.getItem("token");
            const r = await fetch('/api/v1/apps', {
                method:'POST', headers:{'Content-Type':'application/json' , 'Authorization':`Bearer ${token}`},
                body: JSON.stringify({ programId })
            });
            const app = await r.json();
            // go to the application page
            window.location.href = '/app/' + app.id;
        }

        async function checkEligibility(programId){
            try {
                const token = localStorage.getItem("token");
                const prof = await fetch('/api/v1/profile' , {headers: {'Authorization':`Bearer ${token}`}}).then(r=>r.ok?r.json():{});
                const req = {
                    gpa: (+prof.gpa) || 0,
                    ielts: (+prof.ielts) || 0,
                    toefl: (+prof.toefl) || 0,
                    budget: (+prof.budget) || 0,
                    programIds: [programId]
                };
                const token2 = localStorage.getItem("token");
                const res = await fetch('/api/v1/eligibility/check',{
                    method:'POST',
                    headers:{'Content-Type':'application/json' , 'Authorization':`Bearer ${token2}` },
                    body: JSON.stringify(req)
                }).then(r=>r.json());
                const r = res && res[0] ? res[0] : {score:0,eligible:false,reasons:['No data']};
                document.getElementById('eligBody').innerHTML = `
              <div>Score: <b>${r.score}</b> / 100</div>
              <div class="mt-2 ${r.eligible?'text-success':'text-danger'}">${r.eligible?'Eligible':'Not eligible'}</div>
              <ul class="mt-2">${(r.reasons||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
              <div class="mt-3"><a class="btn btn-primary disabled">Create draft (Day 4)</a></div>`;
            } catch(err){
                document.getElementById('eligBody').innerHTML = `<div class="text-danger">Error checking eligibility.</div>`;
            }
            new bootstrap.Modal(document.getElementById('eligModal')).show();
        }

        document.getElementById('filters').addEventListener('submit',search);
        search();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Eligibility Modal -->
    <div class="modal" tabindex="-1" id="eligModal">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Eligibility</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eligBody">Checking...</div>
        </div></div>
    </div>
</div>
</body>
</html>